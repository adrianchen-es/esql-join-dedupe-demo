{
  "processors": [
    {
      "remove": {
        "ignore_missing": true,
        "field": "message",
        "if": "ctx.powershell?.file?.script_block_hash!= null && ctx.fields?.duplicated!= null && (ctx.fields?.duplicated == true || ctx.fields?.duplicated == 'true')",
        "description": "Remove message for lean event"
      }
    },
    {
      "remove": {
        "ignore_missing": true,
        "field": "powershell.file.script_block_text",
        "if": "ctx.powershell?.file?.script_block_hash!= null && ctx.fields?.duplicated!= null && (ctx.fields?.duplicated == true || ctx.fields?.duplicated == 'true')",
        "description": "Remove script_block_text for lean event"
      }
    },
    {
      "script": {
        "if": "ctx.tags!= null && ctx.tags.contains('powershell_scriptblock_reduction') && (ctx.host?.os?.type != null)",
        "source": """ctx._temp = ctx._temp != null ? ctx._temp : new HashMap(); 
if (ctx.host?.os?.type != null) {  
ctx._temp.os_type = ctx.host.os.type;  
ctx.remove('host');  
ctx.host = [:]; ctx.host.os = [:];  
ctx.host.os.type = ctx._temp.os_type;
ctx.remove('_temp');  
} """,
        "description": "Example 1 to retain a field for the lookup index - host.os.type"
      }
    },
    {
      "script": {
        "if": "ctx.tags!= null && ctx.tags.contains('powershell_scriptblock_reduction') && (ctx.user?.id != null)",
        "source": """if (ctx.user instanceof Map) {
def userFieldsToKeep = ['id']; ctx.user.keySet().removeIf(key -> !userFieldsToKeep.contains(key));
}""",
        "description": "Example 2 to retain a field for the lookup index - user.id"
      }
    },
    {
      "script": {
        "if": "ctx.tags!= null && ctx.tags.contains('powershell_scriptblock_reduction') && (ctx.file?.name != null || ctx.file?.path != null || ctx.file?.directory != null)",
        "source": """if (ctx.file instanceof Map) {
def fileFieldsToKeep = ['name', 'path', 'directory']; ctx.file.keySet().removeIf(key -> !fileFieldsToKeep.contains(key));
}""",
        "description": "Retain field for the lookup index - file.name, file,path, file.directory"
      }
    },
    {
      "remove": {
        "ignore_missing": true,
        "field": [
          "winlog",
          "log",
          "agent",
          "powershell.sequence",
          "powershell.total",
          "cloud",
          "elastic_agent",
          "data_stream",
          "message",
          "_temp",
          "input",
          "powershell.file.script_block_id"
        ],
        "if": "ctx.tags!= null && ctx.tags.contains('powershell_scriptblock_reduction')",
        "description": "Remove unnecessary fields from the lookup index"
      }
    },
    {
      "script": {
        "if": "ctx.tags!= null && ctx.tags.contains('powershell_scriptblock_reduction') && ctx.powershell?.file?.script_block_hash!= null",
        "source": "ctx._id = ctx.powershell.file.script_block_hash",
        "description": "Specific the id for the unique script_block_text based on hash"
      }
    },
    {
      "remove": {
        "ignore_missing": true,
        "field": "fields.duplicated",
        "if": "ctx.fields?.duplicated!= null",
        "description": "Remove metadata used to indicate the original event"
      }
    }
  ]
}
